{% extends "base.html" %}
{% block title %}Generate crap{% endblock %}
{% block content %}
<h3 class="grey-text text-lighten-1">What if we paid for GPUs with product placement?</h3>

<div class="row">
    <form id="prompt_form" onsubmit="generateImage(event)">
        <div class="input-field col s12 valign-wrapper">
            <!-- text input -->
            <input placeholder="a surrealist painting that features a melting clock hanging from a barren tree"
                id="prompt" type="text" class="validate" required autofocus>
            <label for="prompt">Prompt</label>

            <!-- model selector -->
            <select id="model">
                <option value="titan">AWS Titan</option>
                <option value="dalle">OpenAI DALL-E 3</option>
            </select>
            <!-- <label for="model">Model</label> -->

            <!-- check box -->
            <div>
                <label>
                    <input type="checkbox" id="unmodified_prompt" />
                    <span>Unmodified Prompt</span>
                </label>
            </div>

            <!-- submit button -->
            <button class="btn waves-effect waves-light submit-button" type="submit" name="action"><span
                    id="button_regular_content">Submit <i class="material-icons right">send</i>
                </span>
                <span id="button_loading_content" style="display: none;">
                    <div class="preloader-wrapper small active">
                        <div class="spinner-layer spinner-green-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </span>

            </button>

        </div>

    </form>
</div>

<div id="response" style="visibility: hidden;">
    <img id="response_img" class="materialboxed" width="1024" height="1024">

    <p>
        Prompt: <span id="response_modified"></span>
    </p>

    <p>
        Original prompt: <span id="response_original"></span>
    </p>
    <p>
        Brand match: <span id="response_brand"></span>
    </p>

</div>

{% endblock %}

{% block scripts %}
<script>
    // note: dedupe with base
    $(document).ready(function () {
        $('select').formSelect();
        $('.slider').slider();
    });

    function beginProcessing() {
        $('#response').css('visibility', 'hidden');
        $('#prompt_form').addClass('form-processing');
        $('button[type="submit"]').removeClass("waves-effect waves-light submit").addClass('disabled');
        $('#button_regular_content').hide();
        $('#button_loading_content').show();
    }

    function endProcessing() {
        $('button[type="submit"]').addClass("waves-effect waves-light submit").removeClass('disabled');
        $('#button_regular_content').show();
        $('#button_loading_content').hide();
        $('#prompt_form').removeClass('form-processing');
    }

    function showResult() {
        $('#response').css('visibility', 'visible');
    }

    function generateImage(event) {
        event.preventDefault();

        if ($('#prompt_form').hasClass('form-processing')) {
            return;
        }

        var prompt = $('#prompt').val();
        var model = $('#model').val();
        var unmodified_prompt = $('#unmodified_prompt').is(':checked');
        beginProcessing();
        $.get('/generate/' + model, { prompt: prompt, unmodified_prompt: unmodified_prompt }, function (response) {

            setTimeout(function () {
                $('#response_original').text(prompt);
                $('#response_brand').text(response.company);
                $('#response_modified').text(response.prompt);

                $('#response_img').attr('src', response.image_url);
                $('#response_img').attr('data-caption', 'Generated by ' + response.model_backend);

                endProcessing();
                showResult();
            }, 2000);
        }).fail(function (error) {
            M.toast({ html: 'Error: ' + error.status + ' ' + error.responseJSON.detail, classes: 'red', displayLength: 10000 });
            console.error('Error:', error);
            endProcessing();
        });
    }

</script>
{% endblock %}